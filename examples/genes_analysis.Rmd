---
title: "Analyzing genes of interest with SolveBio"
output: rmarkdown::html_document
---
```{r, message = FALSE, warning=FALSE}
rm(list=ls())
library(solvebio)
library(data.table)
```
login to SolveBio:
```{r eval=FALSE}
login(api_key="<api_key>", api_host="<api_host>")
```
Define a list of genes for the analysis and create a filter that will be used to query SolveBio datasets:
```{r}
# random sample from clinvar gene_symbols generated by running: genes = sample(unlist(combined_dt[,gene_symbol]),15)
genes = c("MYBPC3", "RDH5", "MYO15A", "FZD4", "DMD", "GLIS3", "ISPD", "C3", "APOB", "ATP6V0A2", "KIF5A", "SNCA", "LDLR", "ANK1", "FBN2")
genes_filter  = '[["gene_symbol__in",["MYBPC3", "RDH5", "MYO15A", "FZD4", "DMD", "GLIS3", "ISPD", "C3", "APOB", "ATP6V0A2", "KIF5A", "SNCA", "LDLR", "ANK1", "FBN2"]]]'
```
SolveBio allows you to query its datasets only for the gene set and fields of interest. In this example, we will query the ClinVar/Combined and GWAS datasets to extract variants and other supporting information for our sample gene list. 

We first query the ClinVar/Combined dataset for the genes in our genes_filter and specify which columns (fields) we want to export:
```{r}
clinvar_genes_q = Dataset.query('ClinVar/Combined', filters=genes_filter, fields=c("variant_sbid", "phenotype", "clinical_significance", "gene_symbol"), paginate=TRUE)
clinvar_genes_dt = as.data.table(clinvar_genes_q)
```
Let's now query the GWAS dataset for the same gene list:
```{r}
gwas_q = Dataset.query("GWAS/GWAS", filters=genes_filter, genome_build="GRCh37", paginate=TRUE)
gwas_dt = as.data.table(gwas_q)
```
SolveBio has enabled easy navigation between these two datasets by standardizing the formats of common entity types such as gene names and variant IDs. Let's merge them by their common field - 'variant_sbid'.

Before we merge with ClinVar/Combined, we need to unlist the variant_sbid column in GWAS:
```{r, echo = TRUE}
# add a column to index the rows in the gwas data table
gwas_dt$rowID<-seq.int(nrow(gwas_dt))
# add another column with the length of the list in variant_sbid
gwas_dt <- gwas_dt[,length_vsbid:=lapply(gwas_dt$variant_sbid,length)]
# create a single column data table with as many rows as there're variant sbids
extra_rows = data.table(rep(gwas_dt$rowID,gwas_dt$length_vsbid))
names(extra_rows)=c("rowID")
# merge the extra rows and the gwas data table to add more rows
expand_gwas = merge(gwas_dt,extra_rows,all=T)
# unlist the variant_sbid column to make it into a vector of single variant_sbid values
varsbids = unlist(gwas_dt$variant_sbid)
setnames(expand_gwas, "variant_sbid", "variant_sbid_list")
# add the expanded varsbids to the expanded data table
expand_gwas[,'variant_sbid'] <- varsbids
# merge clinvar and the expanded gwas
clinvar_gwas = merge(clinvar_genes_dt, expand_gwas, by='variant_sbid')
```
We now have fields from both ClinVar and GWAS in the same data table, keyed by 'variant_sbid':
```{r}
colnames(clinvar_gwas)
```
We can look at summary tables for fields, eg:
```{r}
table(unlist(clinvar_gwas$clinical_significance))
```
Alternately, you can extract summary values for fields using SolveBio's facets:
```{r}
facets = Dataset.facets('ClinVar/Variants', filters=genes_filter, list("clinical_significance", "gene_symbol", "phenotype"))
facets$clinical_significance
facets$gene_symbol
facets$phenotype
```
Let's imagine we have expression data for our gene list of interest for 5 conditions and we want to visualize it with a heatmap:
```{r, message = FALSE}
# simulate an expression matrix for the genes based on min/max values from a real expression dataset:
expr_m = matrix(runif(5*length(genes),0,20), nrow=length(genes), ncol=5)
expr_m <- expr_m[order(expr_m[,1]),]
row.names(expr_m) <- genes
expr_heatmap <- heatmap(expr_m, Rowv=NA, Colv=NA, col = cm.colors(256), scale="column", margins=c(5,10))
```

Similarly, we can use ExpressionSet from Bioconductor/Biobase package to create the heatmap:
```{r, message = FALSE}
# using expression set heatmap
library("Biobase")
minimalSet <- ExpressionSet(assayData=expr_m)
heatmap(exprs(minimalSet))
```


